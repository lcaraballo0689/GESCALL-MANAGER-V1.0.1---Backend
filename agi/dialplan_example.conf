; CallerID Local Presence Extension
; Add this to your Vicidial dialplan (extensions.conf or custom context)
;
; This extension wraps the outbound dial and applies CallerID rotation
; from the GesCall CallerID Pools API
;
; OPTION 1: Create a custom context for campaigns that use Local Presence
; ========================================================================

[gescall-local-presence]
; This is called before dialing. Set the CallerID based on lead's phone
exten => _X.,1,NoOp(GesCall CallerID Local Presence)
exten => _X.,n,Set(ORIGINAL_CID=${CALLERID(num)})
exten => _X.,n,Set(CAMPAIGN=${CDR(accountcode)})
exten => _X.,n,Set(PHONE=${EXTEN})
exten => _X.,n,Set(LEADID=${CHANNEL(leadid)})
exten => _X.,n,AGI(callerid_local_presence.agi,${CAMPAIGN},${PHONE},${LEADID})
exten => _X.,n,NoOp(CallerID set to: ${CALLERID(num)} - Result: ${GESCALL_SELECTION_RESULT})
exten => _X.,n,Return()

; OPTION 2: Macro version (for older Vicidial setups)
; ========================================================================

[macro-gescall-callerid]
exten => s,1,NoOp(GesCall CallerID Macro - Campaign: ${ARG1} Phone: ${ARG2})
exten => s,n,AGI(callerid_local_presence.agi,${ARG1},${ARG2},${ARG3})
exten => s,n,NoOp(CallerID Result: ${GESCALL_SELECTION_RESULT})

; OPTION 3: Simple AGI call in existing dialplan
; ========================================================================
; Just add this line before the Dial() command in your outbound context:
;
; exten => _X.,n,AGI(callerid_local_presence.agi,${CAMPAIGN_ID},${PHONE},${LEAD_ID})
;

; INTEGRATION WITH VICIDIAL
; ========================================================================
; In Vicidial Admin > Campaigns > Dial Method Settings:
; 1. Set Custom Dial Prefix to include the AGI call
; 2. Or modify the campaign's outbound context to include the AGI
;
; For manual integration in extensions_custom.conf:
; Find the outbound context used by your campaign and add the AGI line
; before the Dial() application.
